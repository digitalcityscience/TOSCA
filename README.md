# Open City Toolkit

## Requirements

The Open City Toolkit is a framework connecting several external tools in order to implement a flexible and easy-to-use web GIS solution. A Linux system equipped with several applications is required as a base system:

1. GeoServer
1. GRASS GIS
1. Gnuplot
1. enscript
1. ghostscript
1. inotify-tools
1. Node.js

The following instructions provide guidance for the installation of all required components.

## Installation

### With Docker

You can quickly set up a running system via [Docker](https://docs.docker.com/) – download the contents of this repository, change to its root directory and build the Docker image:
```
docker build -t cityapp .
```

Create required directories:
```
mkdir geoserver_data_dir/data
mkdir grass/global
```

Start a container using the newly created image. In the environment variable `GEOSERVER_URL` in this command, replace "localhost" with your server's hostname.
```
docker run -ti -e GEOSERVER_URL=http://localhost:8080/ -v `pwd`/geoserver_data_dir:/usr/share/geoserver/data_dir -v `pwd`/grass:/root/cityapp/grass -p 3000:3000 -p 8080:8080 --name cityapp cityapp
```

The app will run on http://localhost:3000, and GeoServer will be available at http://localhost:8080/geoserver/.

The `geoserver_data` and `grass` directories are mounted as volumes into the container, in order to make their contents persistent.

### Without Docker

#### Operating system

A Linux system is required. Neither the kernel version, nor the flavour has any significance. Nevertheless, a modern and up-to-date Linux environment is highly recommended.

#### Installation directory

It is recommended to install the app into a home directory of a dedicated user created for this purpose (e.g., `cityapp_user`). This is to clearly separate the data stored in the `cityapp` directory and to allow data management through file permissions. Here it is assumed that the dedicated user's home directory is `/home/cityapp_user`.

#### External components

##### Geoserver

Use a current stable version of GeoServer, at least version 2.15. The expected path of the GeoServer data directory on your system is `/usr/share/geoserver/data_dir/data`, therefore it is required to install GeoServer into `/usr/share/geoserver`.

1. Download a platform independent, fresh, binary version of GeoServer from geoserver.org. It is a zipped file, ready to run after unzip.

2. Create a GeoServer directory:
```
sudo mkdir /usr/share/geoserver
```
3. Allow `cityapp_user` to access that directory. First change owner, and set `cityapp_user` as owner of the GeoServer directory:
```
sudo chown cityapp_user /usr/share/geoserver
```
4. Copy zipped GeoServer to this new directory
```
cp Download/geoserver-2.17.0-bin.zip /usr/share/geoserver
```
5. Unzip:
```
cd /usr/share/geoserver
unzip ./geoserver-2.17.0-bin.zip
```
6. Set permissions of startup and shutdown script:
```
chmod 744 /usr/share/geoserver/bin/startup.sh
chmod 744 /usr/share/geoserver/bin/shutdown.sh
```

Geoserver is now ready to run, but not yet ready to use with the app.

7. Stylesheets are in CSS format, therefore it is required to install a CSS extension for GeoServer. For this end first download the extension from the Geoserver site: https://docs.geoserver.org/latest/en/user/styling/css/install.html

8. Copy the downloaded zip file:
```
cp ~/Download/geoserver-2.16.0-css-plugin.zip /usr/share/geoserver/webapps/geoserver/WEB-INF/lib/
```
9. Unzip copied file:
```
cd /usr/share/geoserver/webapps/geoserver/WEB-INF/lib/
unzip /usr/share/geoserver/webapps/geoserver/WEB-INF/lib/geoserver-2.16.0-css-plugin.zip
```
Geoserver is now able to interpret CSS stylesheets.

10. After installing Geoserver, it is required to create a symbolic link pointing to `~cityapp/geoserver_data`, because GRASS GIS will export the results to that directory.
```
ln -s ~/cityapp/geoserver_data /usr/share/geoserver/data_dir/data/cityapp
```

Maps generated by OCTK require an adequate symbology too, stored as “workspace” in GeoServer’s “workspaces” directory. This new symbology is prepared for OCTK, therefore it can’t be found in the default installation of Geoserver. The `~/cityapp/geoserver_workspaces` directory is used to store these settings in subdirectories named `raster` and `vector`. Those are predefined GeoServer workspaces that need to be linked to the workspaces directory of GeoServer.
```
ln -s ~/cityapp/geoserver_workspaces/raster /usr/share/geoserver/data_dir/workspaces/raster
ln -s ~/cityapp/geoserver_workspaces/vector /usr/share/geoserver/data_dir/workspaces/vector
```

##### GRASS GIS

GRASS GIS is the core component of the backend: a highly developed generic purpose, cross-platform GIS system. It is required to install GRASS GIS version 7.1 or newer. The GRASS GIS installation path has no importance. Download GRASS GIS from: https://grass.osgeo.org/

On a Debian-based system:
```
apt-get install grass
```

For other systems and for further info, please visit: https://grasswiki.osgeo.org/wiki/Installation_Guide

##### Gnuplot

Gnuplot is used to create various data visualizations and export them into PNG format, allowing the browser to display them. Gnuplot is a default component of most Linux distributions, but if your installed system does not contain it, it can be downloaded from http://www.gnuplot.info/.

On a Debian-based system:
```
apt-get install gnuplot
```

##### Node.js

Node.js is a crucial component to run the frontend, therefore it has to be installed properly. Version 12 or higher is required. The recommnded way of installing Node.js in Linux is via [NodeSource](https://github.com/nodesource/distributions) (follow the instructions for your distribution).

On a Debian system:
```
curl -sL https://deb.nodesource.com/setup_12.x | bash -
apt-get install -y nodejs
```

Now change to the webapp directory:
```
cd ~/cityapp/webapp
```
and, before you start the server for the first time, you must run:
```
npm install
```

##### Enscript/Ghostscript

Enscript is a command line tool to convert text files to PostScript, HTML, RTF, ANSI. It is used to create statistical output. If not installed, then:
```
apt-get install enscript
```

Ghostscript is a package containing tools to manage postscript files, including a ps to pdf converter too. If not installed, then:
```
apt-get install ghostscript
```

## Running the app

### GIS backend

To start the backend, run:
```
~/cityapp/scripts/base/ca_starter.sh
```

To stop it:
```
~/cityapp/scripts/base/ca_shutdown.sh
```

### Web app

First change to the `webapp` directory. Before you start the server for the first time, you must run:
```
npm install
```

You must also set the environment variables in the `.env` file. The variables `DATA_FROM_BROWSER_DIR` and `DATA_TO_CLIENT_DIR` refer to the respective directories. The `GEOSERVER_URL` must point to the public URL of the GeoServer instance, which will be running on port 8080. If this is anything other than localhost, change the URL accordingly.

Now to start the server, run:
```
node app.js
```

Open a browser at http://localhost:3000 and you should see the app's user interface.

If you want to use the server in production, it is recommended to use the process manager [pm2](https://pm2.keymetrics.io/). To install it, run:
```
sudo npm install -g pm2
```
To start a process for Cityapp:
```
pm2 start ~/cityapp/webapp/app.js --name=cityapp
```
